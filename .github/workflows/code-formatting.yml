name: Code Formatting and Linting

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  format-backend:
    runs-on: ubuntu-latest
    name: Format Backend Python Code

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev]

    - name: Run Python formatting tools
      working-directory: ./backend
      run: |
        echo "ğŸ”§ Running ruff to fix issues..."
        ruff check --fix .

        echo "ğŸ”§ Running black for code formatting..."
        black .

        echo "ğŸ”§ Running isort for import sorting..."
        isort .

        echo "âœ… Backend formatting complete!"

    - name: Check for changes
      id: verify-changed-files-backend
      run: |
        if [[ -n $(git status --porcelain) ]]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push backend changes
      if: steps.verify-changed-files-backend.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add backend/
        git commit -m "ğŸ¤– Auto-format: Apply Python code formatting fixes

        - Fixed ruff issues (unused imports, variables, etc.)
        - Applied black code formatting
        - Sorted imports with isort

        ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

        Co-Authored-By: GitHub Action <action@github.com>"
        git push

  format-frontend:
    runs-on: ubuntu-latest
    name: Format Frontend TypeScript/React Code

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Install dependencies
      working-directory: ./frontend
      run: npm ci

    - name: Run frontend formatting tools
      working-directory: ./frontend
      run: |
        echo "ğŸ”§ Running Prettier for code formatting..."
        npm run format:fix || npx prettier --write "src/**/*.{ts,tsx,js,jsx,json,css,md}" --ignore-path .gitignore

        echo "ğŸ”§ Running ESLint fixes..."
        npm run lint:fix || npx eslint --fix "src/**/*.{ts,tsx}" --ignore-path .gitignore || true

        echo "âœ… Frontend formatting complete!"

    - name: Check for changes
      id: verify-changed-files-frontend
      run: |
        if [[ -n $(git status --porcelain frontend/) ]]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi

    - name: Commit and push frontend changes
      if: steps.verify-changed-files-frontend.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add frontend/
        git commit -m "ğŸ¤– Auto-format: Apply frontend code formatting fixes

        - Fixed Prettier formatting issues
        - Applied ESLint auto-fixes
        - Consistent TypeScript/React code style

        ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

        Co-Authored-By: GitHub Action <action@github.com>"
        git push

  lint-check:
    runs-on: ubuntu-latest
    name: Final Lint Check
    needs: [format-backend, format-frontend]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Check Backend Code Quality
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install ruff black isort
        echo "ğŸ” Running ruff check..."
        ruff check .
        echo "ğŸ” Running black check..."
        black --check .
        echo "ğŸ” Running isort check..."
        isort --check-only .
        echo "âœ… Backend lint checks passed!"

    - name: Check Frontend Code Quality
      working-directory: ./frontend
      run: |
        npm ci
        echo "ğŸ” Running TypeScript check..."
        npm run type-check
        echo "ğŸ” Running ESLint check..."
        npm run lint
        echo "âœ… Frontend lint checks passed!"